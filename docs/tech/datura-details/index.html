<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Datura Firewall</title>
  
  <meta name="description" content="Technical notes on CalyxOS built-in firewall app" />
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="alternate" type="application/rss+xml" title="CalyxOS" href="/feed.xml">
  <script src="/assets/js/main.js" defer></script>
  
  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon/favicon-16x16.png">
<link rel="manifest" href="/assets/images/favicon/site.webmanifest">
<link rel="shortcut icon" href="/assets/images/favicon/favicon.ico">
<meta name="apple-mobile-web-app-title" content="CalyxOS">
<meta name="application-name" content="CalyxOS">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/images/favicon/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

</head>

  <body>
    <header>
  <div class="wrapper">
    <div class="logoMark emptyLogo"></div>
    <h1 class="logo"><a class="navbar-brand" href="/">CalyxOS</a></h1>
    <label class="clickable toggle search-toggle" for="search-checkbox" tabindex="0" role="button" aria-label="search"><i class="icon search"></i></label>
    <div class="search">
      <input type="checkbox" class="toggle modal-state" id="search-checkbox"></input>
      <div id="search" class="modal" style="">
        <label class="clickable toggle search-toggle" for="search-checkbox" title="close" tabindex="0" role="button"><i class="big icon close"></i></label>
        <form action="/search" id="searchform" name="searchform">
          <input type="search" name="q" autofocus="autofocus" placeholder="">
          <button type="submit">
            <i class="icon headerSearch"></i> Search
          </button>
        </form>
      </div>
    </div>
    <nav class="navbar">
      <input type="checkbox" class="toggle" id="navbar-visible"></input>
      <ul class="navbar-nav">
        <li class="nav-level-0 nav-item"><a class="nav-level-0 nav-link " href="/features/">Features</a></li>
<li class="nav-level-0 nav-item"><a class="nav-level-0 nav-link " href="/community/">Community</a></li>
<li class="nav-level-0 nav-item"><a class="nav-level-0 nav-link active" href="/docs/">Documentation</a></li>
<li class="nav-level-0 nav-item"><a class="nav-level-0 nav-link " href="/news/">News</a></li>
        <li><a role="button" class="btn primaryBtn" href="/install">Get CalyxOS</a></li>
      </ul>
      <label class="clickable toggle navbar-toggle" for="navbar-visible" role="button" aria-label="navigation"></label>
    </nav>
  </div>
</header>

    <main>
      <section class="secondaryIntro">
        <div class="wrapper sidebar-spacing">
          <h1><span class="highlighter">Datura Firewall</span></h1>
<p>Technical notes on CalyxOS built-in firewall app</p>

        </div>
      </section>
      <div class="wrapper sidebar">
        <div class="navside">
  <ul class="">


<li class="nav-level-1 nav-item"><a class="nav-level-1 nav-link " href="/docs/about/">About</a></li>
<li class="nav-level-1 nav-item"><a class="nav-level-1 nav-link " href="/docs/guide/">User Guide</a></li>
<li class="nav-level-1 nav-item"><a class="nav-level-1 nav-link " href="/docs/tech/">Tech</a></li><li class="nav-level-2 nav-item"><a class="nav-level-2 nav-link " href="/docs/tech/microg-details/">microG</a></li>
<li class="nav-level-2 nav-item"><a class="nav-level-2 nav-link active" href="/docs/tech/datura-details/">Datura</a></li>
<li class="nav-level-1 nav-item"><a class="nav-level-1 nav-link " href="/docs/development/">Development</a></li>

  </ul>
</div>

        <section class="content primaryContent">
          
          <p>The firewall could generally be considered to be composed of 3 layers for each of its features. A UI layer, the frameworks layer (see <a href="https://developer.android.com/guide/platform#api-framework">https://developer.android.com/guide/platform#api-framework</a>), and the netd layer (see <a href="https://developer.android.com/guide/platform#native-libs">https://developer.android.com/guide/platform#native-libs</a>).</p>

<h3 id="ui">UI</h3>
<p>This is the layer visibly exposed to users (toggles, text, …).
It is responsible for passing down information (global toggle switched or app restriction applied, in which case it sends the UID of the app and the policy or rule related to the feature) about a user’s selection to the frameworks for processing.</p>

<h3 id="frameworks">Frameworks</h3>
<p>Responsible for the first level of processing (e.g. sanity checks, state machine, …), managing the dynamics of a feature (e.g. app in background) and passing down the inputs to netd to apply policies and rules.</p>

<h3 id="netd">Netd</h3>
<p>At its core, the firewall makes use of standard Linux networking utilities to process traffic (see <a href="https://source.android.com/devices/architecture/hidl/network-stack">https://source.android.com/devices/architecture/hidl/network-stack</a>). Netd is responsible for the last level of processing and calls the networking utilities, passing in the input for any operation.</p>

<h2 id="features">Features</h2>

<h3 id="per-interface-network-usage-restrictions">Per-interface network usage restrictions</h3>
<ul>
  <li>Code: <a href="https://review.calyxos.org/q/topic:data-restriction">https://review.calyxos.org/q/topic:data-restriction</a></li>
</ul>

<p>On devices with Linux kernel versions 4.9 and below, this setting uses iptables to add an app to the INPUT and OUTPUT chains and limits its traffic based on the specified incoming and outgoing networking interface.
On devices with Linux kernel versions higher than 4.9, the bandwidth restrictions make use of eBPF instead of iptables (see https://source.android.com/devices/tech/datausage/ebpf-traffic-monitor)</p>

<h3 id="per-app-network-isolation">Per-app network isolation</h3>
<ul>
  <li>Code: <a href="https://review.calyxos.org/q/topic:network-isolation">https://review.calyxos.org/q/topic:network-isolation</a></li>
</ul>

<p>On devices with Linux kernel versions 4.9 and below, this setting uses iptables to add an app to the firewall isolated chain (which is referenced in the firewall INPUT and OUTPUT chains).
On devices with Linux kernel versions higher than 4.9, the bandwidth restrictions make use of eBPF instead of iptables (see https://source.android.com/devices/tech/datausage/ebpf-traffic-monitor)</p>

<h3 id="background-network-access-restrictions">Background network access restrictions</h3>
<ul>
  <li>Code: <a href="https://review.calyxos.org/q/topic:background-data">https://review.calyxos.org/q/topic:background-data</a></li>
</ul>

<p>This setting adds an app to the penalty box iptables chain. On AOSP, this chain can be reached via costly interface chains (metered networks, which mobile data and VPN networks default to, are considered costly). In CalyxOS, the penalty box is instead added at the bandwidth INPUT, OUTPUT and FORWARD chains so that all interfaces block background bandwidth</p>

<h3 id="cleartext-traffic-restrictions">Cleartext traffic restrictions</h3>
<ul>
  <li>Code: <a href="https://review.calyxos.org/q/topic:global-no-cleartext">https://review.calyxos.org/q/topic:global-no-cleartext</a></li>
  <li>Code: <a href="https://review.calyxos.org/q/topic:global-no-cleartext-allowlist">https://review.calyxos.org/q/topic:global-no-cleartext-allowlist</a></li>
</ul>

<p>Normally, each app can make and remove its own strict mode cleartext restriction chain. The global cleartext restriction setting disallows this and appends a cleartext restriction chain that applies to all UIDs. Since it is appended (lower priority), apps can be allowed cleartext traffic in a manual override.
Cleartext DNS traffic is briefly allowed for the root user in order to establish a private DNS connection.</p>



        </section>
      </div>
    </main>
    <footer>
      
<div class="shade">
  <div class="wrapper">
    <div class="row">
      <ul>
        <li><a href="https://calyxinstitute.org/about">About Calyx</a></li>
        <li><a href="https://calyxinstitute.org/membership">Join Calyx</a></li>
        <li><a href="https://calyxinstitute.org/about/contact-us">Contact Us</a></li>
        <li><a href="https://calyxinstitute.org/legal/privacy-policy">Privacy Policy</a></li>
        <li><a href="https://calyxinstitute.org/legal/terms-of-service">Terms of Service</a></li>
        <li><a href="https://members.calyxinstitute.org/donate">Donate</a></li>
      </ul>
    </div>
    <div class="row footer-icons">
      <a href="https://app.element.io/#/room/#calyxos:matrix.org" title="CalyxOS chat room">
        <img class="filter-grey" src="/assets/images/icons/matrix.svg" />
      </a>
      <a href="https://gitlab.com/CalyxOS" title="CalyxOS source code">
        <img class="filter-grey" src="/assets/images/icons/git.svg" />
      </a>
      <a href="https://twitter.com/calyxinstitute" title="Calyx Institute on Twitter">
        <img class="filter-grey" src="/assets/images/icons/twitter.svg" />
      </a>
      <a rel="me" href="https://mastodon.social/@calyxinstitute" title="Calyx Institute on Mastodon">
        <img class="filter-grey" src="/assets/images/icons/mastodon.svg" />
      </a>
      <a href="https://reddit.com/r/CalyxOS" title="CalyxOS on Reddit">
        <img class="filter-grey" src="/assets/images/icons/reddit.svg" />
      </a>
      <a href="https://facebook.com/calyxinstitute" title="Calyx Institute on Facebook">
        <img class="filter-grey" src="/assets/images/icons/facebook.svg" />
      </a>
      <a href="https://instagram.com/calyxinsta" title="Calyx Institute on Instagram">
        <img class="filter-grey" src="/assets/images/icons/instagram.svg" />
      </a>
    </div>
    <div class="row">
      <a href="https://calyxinstitute.org" target="_blank" rel="noreferrer nooopener">&copy; 2021-2025 Calyx Institute</a>
      <span class="spacer" aria-hidden="true">&bull;</span>
      <a target="_blank" href="https://review.calyxos.org/admin/repos/edit/repo/CalyxOS/calyxos.org/branch/refs/heads/main/file/pages/docs/tech/datura-details/index.md">Edit page</a>
    </div>
    <div class="row">
      <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener noreferrer nofollow" title="License: Attribution-ShareAlike 4.0 International"><img class="filter-grey" style="height: 24px" src="/assets/images/icons/cc-by-sa.svg" /></a>
    </div>
  </div>
</div>

    </footer>
  </body>
</html>
